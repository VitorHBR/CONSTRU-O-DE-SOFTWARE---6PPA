<script src="/js/Insumo/listar.js"></script>
<script src="/js/Receita/listar.js"></script>
<script src="https://cdn.tiny.cloud/1/jx8n5u59kuabgngl2eiqz5zowsqibk4no22yy0f75chwjxax/tinymce/5/tinymce.min.js"referrerpolicy="origin"></script>

<body onload="listarinsumo()">
  <div>
    <h1>Receitas</h1>
    <div>
      <nav class="navbar bg-body-tertiary">
        <div class="container-fluid">
          <form class="d-flex" role="search" method="post" action="/receita/buscarreceita">
            <input class="form-control me-2" type="search" placeholder="Procurar" aria-label="Search" name="busca">
            <button class="btn btn-outline-success" type="submit">Buscar</button>
          </form>
          <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exampleModal"
            data-bs-whatever="@mdo"><i class="fas fa-plus"></i> Cadastrar</button>
        </div>
      </nav>
      <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h1 class="modal-title fs-5" id="exampleModalLabel">Cadastrar Nova Receita</h1>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <form action="/receita/cadastrarreceita" method="post" >
                <div class="mb-3">
                  <label for="nome" class="col-form-label">Nome:</label>
                  <input name="nome" type="text" class="form-control" id="nome">
                </div>
                <div class="mb-3">
                  <label for="message-text" class="col-form-label">Descrição:</label>
                  <textarea name="descricao" class="form-control" id="descricao"></textarea>
                </div>
                <div class="mb-3">
                  <label for="message-text" class="col-form-label">Modo de Preparo:</label>
                  <textarea name="modoPreparo" class="form-control" id="modoPreparo"></textarea>
                </div>
                <div class="form-row">
                  <div class="col-md-5">
                    <label for="insumo">Insumo:</label>
                    <select class="form-control" id="insumo">
                      <!-- Opções do select com os insumos -->
                    </select>
                  </div>
                  <div class="col-md-5">
                    <label for="quantidadeInsumo">Quantidade:</label>
                    <input type="number" class="form-control" id="quantidadeInsumo" placeholder="Quantidade">
                  </div>

                  <div class="col-md-2 align-self-end">
                    <label for="quantidadeInsumo">Ações:</label>
                    <button type="button" class="btn btn-primary mt-2" onclick="adicionarInsumo()">Adicionar</button>
                  </div>

                  <div class="mb-3">
                    <label for="tabelaInsumos" class="col-form-label">Lista de Insumos:</label>
                    <table class="table table-bordered" id="tabelaInsumos">
                      <thead>
                        <tr>
                          <th>Insumo</th>
                          <th>Quantidade</th>
                        </tr>
                      </thead>
                      <tbody>

                      </tbody>
                    </table>
                  </div>
                </div>
                <div class="modal-footer">
                  <button class="btn btn-primary" type="submit" onclick="cadastrarReceita(
                      document.getElementById('nome').value,
                      document.getElementById('descricao').value,
                      document.getElementById('modoPreparo').value,
                      document.getElementById('insumo').value
                    )">Cadastrar
                  </button>
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Sair</button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="table-responsive" style="margin-top: 15px;">
      <table class="table table-striped table-hover">
        <thead>
          <tr>
            <th>Código</th>
            <th>Nome</th>
            <th>Descrição</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody>
          <% lista.map(function(value, index) { %>
            <tr>
              <td id="cod">
                <%= value.idReceita %>
              </td>
              <td id="nome">
                <%= value.nome %>
              </td>
              <td id="descricao">
                <%= value.descricao %>
              </td>
              <td>
                <div class="d-flex">
                  <div class="me-1">
                    <button onclick="alterar('<%= value.nome %>')" type="button" class="btn btn-primary"
                      data-bs-toggle="modal" data-bs-target="#exampleAlterar<%= value.idReceita %>"
                      data-bs-whatever="@alterar"><i class="fas fa-pen"></i></button>
                    <div class="modal fade" id="exampleAlterar<%= value.idReceita %>" tabindex="-1"
                      aria-labelledby="exampleAltear<%= value.idReceita%>Label" aria-hidden="true">
                      <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                          <div class="modal-header">
                            <h1 class="modal-title fs-5" id="exampleAltear<%= value.idReceita %>Label">Alterar Receita
                            </h1>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                          </div>
                          <div class="modal-body">
                            <form method="post" action="/receita/alterarreceita">
                              <div class="mb-3">
                                <input type="text" hidden="true" name="codigo" value="<%= value.idReceita %>">
                              </div>
                              <div class="mb-3">
                                <label for="message-text" class="col-form-label">Nome:</label>
                                <input name="nome" type="text" class="form-control" id="alterarnome"
                                  value="<%= value.nome %>">
                              </div>
                              <div class="mb-3">
                                <label for="message-text" class="col-form-label">Descrição:</label>
                                <textarea name="descricao" class="form-control"
                                  id="alterarescricao"><%= value.descricao %></textarea>
                              </div>
                              <div class="mb-3">
                                <label for="message-text" class="col-form-label">Modo de Preparo:</label>
                                <textarea name="modoPreparo" class="form-control" id="modoPreparo"
                                  id="alterarModoPreparo"><%= value.modoPreparo %></textarea>
                              </div>
                              <div class="form-row">
                                <div class="col-md-5">
                                  <label for="insumo">Insumo:</label>
                                  <select class="form-control" id="insumo">
                                    <!-- Opções do select com os insumos -->
                                  </select>
                                </div>
                                <div class="col-md-5">
                                  <label for="quantidadeInsumo">Quantidade:</label>
                                  <input type="number" class="form-control" id="quantidadeInsumo"
                                    placeholder="Quantidade">
                                </div>
                                <div class="col-md-3 align-self-end">
                                  <button type="button" class="btn btn-primary mt-2" id="adicionar">Adicionar</button>
                                </div>
                              </div>
                              <button class="btn btn-primary" type="submit">Alterar</button>
                            </form>
                          </div>
                          <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Sair</button>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  <a class="btn btn-danger" href="/receita/deletarreceita/<%= value.idReceita %>" role="button"><i
                      class="fas fa-trash"></i></a>
                </div>
                <div class="d-flex">

                </div>
              </td>
            </tr>
            <% }) %>
        </tbody>
      </table>
    </div>
  </div>
</body>

<script>

  let insumos = [];

  function adicionarInsumo() {
    const insumoSelect = document.getElementById('insumo');
    const insumo = insumoSelect.value;
    const quantidadeInput = document.getElementById('quantidadeInsumo');
    const quantidade = parseInt(quantidadeInput.value);

    // Verifica se o insumo já está na lista
    const insumoExistente = insumos.find(item => item.insumo === insumo);
    if (insumoExistente) {
      // Atualiza a quantidade do insumo existente
      insumoExistente.quantidade += quantidade;
    } else {
      // Cria o objeto do insumo
      const novoInsumo = {
        insumo: insumo,
        quantidade: quantidade
      };
      // Adiciona o insumo à lista
      insumos.push(novoInsumo);
    }

    // Limpa os campos do formulário
    insumoSelect.value = '';
    quantidadeInput.value = '';

    // Atualiza a tabela de insumos
    atualizarTabelaInsumos();
  }

  function atualizarTabelaInsumos() {
    const tabelaInsumos = document.getElementById('tabelaInsumos');
    tabelaInsumos.innerHTML = '';

    for (const insumo of insumos) {
      const row = document.createElement('tr');
      row.innerHTML = `
      <td>${insumo.insumo}</td>
      <td>${insumo.quantidade}</td>
      <td>
        <a class="btn btn-danger" role="button" onclick="removerInsumo('${insumo.insumo}')"><i class="fas fa-trash"></i></a>
      </td>
    `;
      tabelaInsumos.appendChild(row);
    }
  }

  function removerInsumo(insumo) {
    const index = insumos.findIndex(item => item.insumo === insumo);
    if (index !== -1) {
      insumos.splice(index, 1);
      // Atualiza a tabela de insumos
      atualizarTabelaInsumos();
    }
  }

  function cadastrarReceita(nome, descricao, modoPreparo,insumos) {
    console.log('Cadastro finalizado!');
    console.log('Nome:', nome);
    console.log('Descrição:', descricao);
    console.log('Modo de Preparo:', modoPreparo);
    console.log('Insumos:', insumos);

    // Crie um objeto com os dados da receita
    const dados = {
      nome: nome,
      descricao: descricao,
      modoPreparo: modoPreparo,
      insumos: insumos
    };

    console.log(dados);

    atualizarTabelaInsumos();
  }
</script>